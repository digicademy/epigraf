# Acceptance testing with Codeception

## General

[Codeception](https://codeception.com/) is used for all kind of frontend related test cases, for example validating HTML output and simulating user interactions.
In Epigraf, there are two kinds of validation approaches:
1. Using JS-like DOM manipulation methods to check elements' visibility, counting elements etc.
2. Using Visual Regression to compare screenshots of pages (or specified HTML elements)

## Directory structure: Overview

Inside the `Codeception` directory there are several subdirectories:

- `_data`
  - `references`: Contains comparison screenshots for the Visual regression tests. The name structure of the screenshots in the most cases follows the pattern `<fileName>.<functionName>.<htmlElementName>.png`. For example, the screenshot `ArticlesCest.deleteSection.section.png` is used for the `deleteSection` method in `ArticlesCest.php` and compares screenshots for the HTML element with the CSS class `section`(Note: The names of the screenshot can be customized inside the test function). **The screenshots are the reference for all Visual Regression tests and are under version control**.
- `output`: Contains all output that is generated by the test functions. If a test fails, a screenshot and a source code dump (HTML) is taken. The file name structure is the same as in the `references` directory (see above): A failed `editNote` test in `ArticlesCest.php` gets a `ArticlesCest.editNote.fail.html` and a `ArticlesCest.editNote.fail.png` file.
  - `current`: *Only for Visual Regression tests*. If a Visual Regression test fails (= the test produces a screenshot that looks different than the reference screenshot), the screenshot is stored here. Every time the test fails again, the screenshot is overriden.
  - `debug`: *Only for Visual Regression tests*.If a Visual Regression test fails (= the test produces a screenshot that looks different than the reference screenshot), the two screenshots are merged into one and the deviant pixels are colored red.
- `_support`: Additional functionalities that can be used in test cases. Contains the customizable `AcceptanceTests.php` trait with functionalities that are used in multiple places (`focus()`, `login()`). Additional helper functions should be stored here.
  - `_generated/`: Contains the `AcceptanceTesterActions.php` file with the default testing functions provided by Codeception.
- `acceptance`: Contains the files with testing functions. The file names mimic the Epigraf app structure and contain tests for these pages (`ArticlesCest.php` for articles, `PropertiesCest.php` for properties etc.)

The data used for the tests are stored in SQL dumps in `TestData/Databases` (NOT in the `Codeception` directory):
- `test_epigraf.sql`: Contains app-wide data (Users, Docs, Jobs etc.)
- `test_projects.sql`: Contains project-specific data (Articles, Items, Properties etc.). Is a small version of an existing project.


## Run the tests

After you configured PHPStorm (see below), right-click on the `Codeception` folder in `tests`, select `Run` and in the menu `Codeception (Codeception)`.
Alternatively, select the codeception configuration and click the play button.

Usually, all tests are run at once.
If you are developing a new test or a file with several tests,
you can only run these by right click on the file or the test function itself.
Running single files or single tests might require configuring the default configuration template.
This should be done automatically during the Epigraf installation process, but can be done manually:
- Open the test dropdown menu in the top right and select `Edit configurations`
- Click `Edit configuration templates` in the bottom left.
- Go to `Codeception`, check `Use alternative configuration file` and enter `\\wsl$\Ubuntu\home\jakob\epigraf\code\html\codeception.yml`
  (replace `jakob` by your username)
- Set scope to `Method`
- Add the environment variable `CODECEPTION=true`
- Select `test_php` as interpreter

Now, every single new test will contain the default settings.


## Develop and debug tests

Each time a test fails, a screenshot and a source code dump is taken.
You find both in the `_output/` folder. For visual comparison tests,
a comparison screenshot is saved in `_debug/` and the current version in `current/`.

You can set breakpoints in your tests (not in the application code).
If you run a test in debug mode from the context menu, the test will
stop at the breakpoint, then you can inspect the variables or the database
(for database access see the configuration section below).

Incomplete tests can be marked with `@incomplete` in the doc blocks.

You can inspect how the tests see the app by setting the test option
in `app.php` to true. If you don't have this option, insert into app.php:

```php
'test' => filter_var(env('TEST', true), FILTER_VALIDATE_BOOLEAN),
```

This works once the test databases were populated, usually after running
the tests at least once.

If tests fail make sure to clear the cache in the container and build the app:
```
bin/cake cache clear_all
npm run build
```


## Deploy tests
In the deployment pipeline of GitLab, only tests in the deploy group are executed.
To reduce server load, we skip similar tests, for example, the starting pages
of every menu point work nearly the same. It is sufficient to test the most complex
case.

Once a test is working as expected and when it should be included in the pipeline,
add the group tag, for example:

```php
    /**
     * Scenario: Select two consecutive articles and export them to JSON.
     *
     * @group deploy
     * @param AcceptanceTester $I
     * @return void
     */
```

To run deployment tests only, add the following options to the config:
```
--xml --html --group deploy --coverage --coverage-xml --coverage-html
```

To skip incomplete tests, add the group tag 'incomplete' to the test and the following options to the config:
```
--xml --html --skip-group incomplete --coverage --coverage-xml --coverage-html
```


## Available methods

Codeception ships with a variety of methods ([see official documentation](https://codeception.com/docs/modules/WebDriver)) that can be found in the `AcceptanceTesterActions` trait in `_support/_generated/`.
In PHPStorm, ctrl+click on a method in one of the tests to open the trait and see the available methods.

Custom methods are defined in `AcceptanceTester.php`, for example the login methods.

## Comparison screenshots
Some tests compare the visual appearance to a reference screenshot.
Reference screenshots are located in `_data/references`. If a test
implements a visual comparison and the reference is not yet there it
will be created. Thus, to update references, delete them and then run the test.

You can set $shouldOverwriteScreenshots to true in the  AcceptanceTester class
to overwrite the reference screenshots automatically when the tests run.
Make sure to set it back to false after updating the references.
Otherwise, all screenshot based tests will always succeed

## Test data
All tests run on the databases in the `test_sql` container.
Before each test, the test databases are populated with the two dumps located in `tests/Testdata/Databases`.
See the `readme.md` in that folder for instructions on how to create the dumps.
The data is cleared after each test, so you can safely edit it within a test.

You can add additional records programmatically using the DB module.
See `HelpCest.php:scrollTable()` as an example.

To see the content of the test databases, you can connect to the server using
clients such as HeidiSQL with the following settings:
- Host: `127.0.0.1`
- Port: `3307`
- Username: `root`
- Password: `root`

## Installation and configuration

All tests run in the `test_php` container.

Note: The configuration steps below are normally done automatically during the first installation of the project and should not be necessary.
However, if something fails, follow the instructions below.

### Configure test framework
- `Settings` -> `PHP` -> `Test Frameworks` -> `+` -> `Add Codeception By Remote Interpreter`
- Path to Codeception executable: `vendor/codeception/codeception/codecept`
- Default configuration file:  `/var/www/html/codeception.yml`
  (adjust path to your system)

### Configure remote interpreter
- `Settings` -> `PHP` -> `CLI Interpreter` -> Click `...`
- Add new interpreter (`+` on top left) -> `From Docker...`
  - Server: `Docker`
  - Configuration file: `./docker-compose.yml`
  - Service: `test_php` (this will also be the name of the interpreter)

## Help
- [Codeception documentation for available testing methods](https://codeception.com/docs/modules/WebDriver)
- [JetBrains Help Page for Codeception](https://www.jetbrains.com/help/phpstorm/using-codeception-framework.html#)
- [How to configure Selenium in Codeception](https://codeception.com/docs/modules/WebDriver#Selenium)

Acceptance tests need selenium, which is automatically started in acceptance.suite.yml
by the following command (see https://codeception.com/extensions#RunProcess for further information):

```
xvfb-run -a java -jar -Dwebdriver.chrome.driver="/usr/bin/chromedriver" /opt/selenium/selenium-server-standalone.jar > /dev/null 2>&1 &
```

## Code coverage
- [See the Codeception documentation](https://codeception.com/docs/Codecoverage)
- [See the GitHub documentation](https://github.com/Codeception/c3)
