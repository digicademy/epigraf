<?php
/**
 * Epigraf 5.0
 *
 * @author     Epigraf Team
 * @contact    jakob.juenger@adwmainz.de
 * @license    https://www.gnu.org/licenses/old-licenses/gpl-2.0.html GPL 2.0
 *
 */

namespace App\Test\TestCase\Utilities\Converters;

use App\Utilities\Converters\HistoricDates;
use App\Utilities\Files\Files;
use Cake\Core\Configure;
use Cake\TestSuite\TestCase;

/**
 * Numbers Test Case
 */
class HistoricDatesTest extends TestCase
{

    public $testData;
    public $testData_v5;

    /**
     * setUp method
     *
     * @return void
     */
    public function setUp(): void
    {
        parent::setUp();

        // Ordered list of dates
        $this->testData = [
            '3 v.Chr.' => [
                'value' => '3 v.Chr.',
                'sort' => '-0003AAA00000000A4',
                'from' => -3,
                'to' => -3
            ],
            '1200 v. Chr. - 1. Jh. v.Chr.' => [
                'value' => '1200 v.Chr.–1.Jh. v.Chr.',
                'sort' => '-0100BBE-8800AABA4',
                'from' => -1200,
                'to' => -1
            ],
            '3 n. Chr.' => [
                'value' => '3',
                'sort' => '00003AAA00000000A4',
                'from' => 3,
                'to' => 3
            ],
            '800 v. Chr. - 1. Jh.' => [
                'value' => '800 v.Chr.–1.Jh.',
                'sort' => '00100BBE-9200AABA4',
                'from' => -800,
                'to' => 100
            ],
            '1200' => [
                'value' => '1200',
                'sort' => '01200AAA00000000A4',
                'from' => 1200,
                'to' => 1200
            ],
            'vor 1200' => [
                'value' => 'vor 1200',
                'sort' => '01200AAB00000000A4',
                'from' => 1175,
                'to' => 1200
            ],
            'um 1200' => [
                'value' => 'um 1200',
                'sort' => '01200AAD00000000A4',
                'from' => 1190,
                'to' => 1210
            ],
            'nach 1200' => [
                'value' => 'nach 1200',
                'sort' => '01200AAF00000000A4',
                'from' => 1200,
                'to' => 1225
            ],
            '1500' => [
                'value' => '1500',
                'sort' => '01500AAA00000000A4',
                'from' => 1500,
                'to' => 1500
            ],
            '1501' => [
                'value' => '1501',
                'sort' => '01501AAA00000000A4',
                'from' => 1501,
                'to' => 1501
            ],
            'Anfang 16. Jh' => [
                'value' => 'A.16.Jh.',
                'sort' => '01501ABF00000000A4',
                'from' => 1501,
                'to' => 1525
            ],
            '1410 - Anfang 16. Jh' => [
                'value' => '1410–A.16.Jh.',
                'sort' => '01501BBF08590AABA4',
                'from' => 1410,
                'to' => 1525
            ],
            '1520' => [
                'value' => '1520',
                'sort' => '01520AAA00000000A4',
                'from' => 1520,
                'to' => 1520
            ],
            '1520 ?' => [
                'value' => '1520?',
                'sort' => '01520AAA00000000B4',
                'from' => 1520,
                'to' => 1520
            ],
            '1520 - 1522' => [
                'value' => '1520–1522',
                'sort' => '01522BAA08480AABA4',
                'from' => 1520,
                'to' => 1522
            ],
            '1524 oder 1525' => [
                'value' => '1524 oder 1525',
                'sort' => '01525AAA08476AAAA4',
                'from' => 1524,
                'to' => 1525
            ],
            '1525 oder 1524' => [
                'value' => '1525 oder 1524',
                'sort' => '01525AAA08476AAAA4',
                'from' => 1524,
                'to' => 1525
            ],
            '1.V. 16. Jh' => [
                'value' => '1.V.16.Jh.',
                'sort' => '01525ABA00000000A4',
                'from' => 1501,
                'to' => 1525
            ],
            '1.D. 16. Jh' => [
                'value' => '1.D.16.Jh.',
                'sort' => '01533ABA00000000A4',
                'from' => 1501,
                'to' => 1533
            ],
            '2.V. 16. Jh' => [
                'value' => '2.V.16.Jh.',
                'sort' => '01550ABA00000000A4',
                'from' => 1525,
                'to' => 1550
            ],
            '1.H. 16. Jh' => [
                'value' => '1.H.16.Jh.',
                'sort' => '01550ABB00000000A4',
                'from' => 1501,
                'to' => 1550
            ],
            'Mitte 16. Jh' => [
                'value' => 'M.16.Jh.',
                'sort' => '01550ABC00000000A4',
                'from' => 1525,
                'to' => 1575
            ],
            '2.D. 16. Jh' => [
                'value' => '2.D.16.Jh.',
                'sort' => '01566ABA00000000A4',
                'from' => 1533,
                'to' => 1566
            ],
            '3.V. 16. Jh' => [
                'value' => '3.V.16.Jh.',
                'sort' => '01575ABA00000000A4',
                'from' => 1550,
                'to' => 1575
            ],
            'Ende 16. Jh' => [
                'value' => 'E.16.Jh.',
                'sort' => '01600ABA00000000A4',
                'from' => 1575,
                'to' => 1600
            ],
            '4.V. 16. Jh' => [
                'value' => '4.V.16.Jh.',
                'sort' => '01600ABB00000000A4',
                'from' => 1575,
                'to' => 1600
            ],
            '3.D. 16. Jh' => [
                'value' => '3.D.16.Jh.',
                'sort' => '01600ABC00000000A4',
                'from' => 1566,
                'to' => 1600
            ],
            '2.H. 16. Jh' => [
                'value' => '2.H.16.Jh.',
                'sort' => '01600ABD00000000A4',
                'from' => 1550,
                'to' => 1600
            ],
            '2.–3. D. 16. Jh.' => [
                'value' => '2.-3.D.16.Jh.',
                'sort' => '01600ABD08434BA0A4',
                'from' => 1533,
                'to' => 1600
            ],
            '16. Jh' => [
                'value' => '16.Jh.',
                'sort' => '01600ABE00000000A4',
                'from' => 1501,
                'to' => 1600
            ],
            '15.-16. Jh' => [
                'value' => '15.–16.Jh.',
                'sort' => '01600BBE08500BEBA4',
                'from' => 1401,
                'to' => 1600
            ],
            'Anfang 17. Jh' => [
                'value' => 'A.17.Jh.',
                'sort' => '01601ABF00000000A4',
                'from' => 1601,
                'to' => 1625
            ]
        ];

        $this->testData_v5 = [
            'A.14.Jh' => [
                'r1' => '1301.01.01.00',
                'r2' => '1301.01.01.00',
                'r3' => '1309.12.31.24',
                'key' => '1301010100-1301010100-1309123124'
            ],
            '1399' => [
                'r1' => '1399.12.31.24',
                'r2' => '1399.01.01.00',
                'r3' => '1399.12.31.24',
                'key' => '1399123124-1399010100-1399123124'
            ],
            'vor 1400' => [
                'r1' => '1400.01.01.00',
                'r2' => '1391.01.01.00',
                'r3' => '1400.01.01.00',
                'key' => '1400010100-1391010100-1400010100'
            ],
            'E.14.Jh' => [
                'r1' => '1400.12.31.24',
                'r2' => '1391.01.01.00',
                'r3' => '1400.12.31.24',
                'key' => '1400123124-1391010100-1400123124'
            ],
            '1400 o. früher' => [
                'r1' => '1400.12.31.24',
                'r2' => '1391.01.01.00',
                'r3' => '1400.12.31.24',
                'key' => '1400123124-1391010100-1400123124'
            ],
            'um 1400' => [
                'r1' => '1400.12.31.24',
                'r2' => '1391.01.01.00',
                'r3' => '1409.12.31.24',
                'key' => '1400123124-1391010100-1409123124'
            ],
            '1400' => [
                'r1' => '1400.12.31.24',
                'r2' => '1400.01.01.00',
                'r3' => '1400.12.31.24',
                'key' => '1400123124-1400010100-1400123124'
            ],
            '1400 o. später' => [
                'r1' => '1400.12.31.24',
                'r2' => '1400.01.01.00',
                'r3' => '1409.12.31.24',
                'key' => '1400123124-1400010100-1409123124'
            ],
            'nach 1400 ' => [
                'r1' => '1400.12.31.24',
                'r2' => '1400.12.31.24',
                'r3' => '1409.12.31.24',
                'key' => '1400123124-1400123124-1409123124'
            ],
            'A.15.Jh.' => [
                'r1' => '1401.01.01.00',
                'r2' => '1401.01.01.00',
                'r3' => '1409.12.31.24',
                'key' => '1401010100-1401010100-1409123124'
            ],
            '1401' => [
                'r1' => '1401.12.31.24',
                'r2' => '1401.01.01.00',
                'r3' => '1401.12.31.24',
                'key' => '1401123124-1401010100-1401123124'
            ],
            '1410-1413' => [
                'r1' => '1410.12.31.24',
                'r2' => '1410.01.01.00',
                'r3' => '1413.12.31.24',
                'key' => '1410123124-1410010100-1413123124'
            ],
            '1.V.15.Jh' => [
                'r1' => '1425.12.31.24',
                'r2' => '1401.01.01.00',
                'r3' => '1425.12.31.24',
                'key' => '1425123124-1401010100-1425123124'
            ],
            '1425' => [
                'r1' => '1425.12.31.24',
                'r2' => '1425.01.01.00',
                'r3' => '1425.12.31.24',
                'key' => '1425123124-1425010100-1425123124'
            ],
            '1433' => [
                'r1' => '1433.12.31.24',
                'r2' => '1433.01.01.00',
                'r3' => '1433.12.31.24',
                'key' => '1433123124-1433010100-1433123124'
            ],
            '1.D.15.Jh.' => [
                'r1' => '1434.12.31.24',
                'r2' => '1401.01.01.00',
                'r3' => '1434.12.31.24',
                'key' => '1434123124-1401010100-1434123124'
            ],
            '1434' => [
                'r1' => '1434.12.31.24',
                'r2' => '1434.01.01.00',
                'r3' => '1434.12.31.24',
                'key' => '1434123124-1434010100-1434123124'
            ],
            'M.14.-M.15.Jh.' => [
                'r1' => '1450.12.31.24',
                'r2' => '1341.01.01.00',
                'r3' => '1459.12.31.24',
                'key' => '1450123124-1341010100-1459123124'
            ],
            '1.H.15.Jh.' => [
                'r1' => '1450.12.31.24',
                'r2' => '1401.01.01.00',
                'r3' => '1450.12.31.24',
                'key' => '1450123124-1401010100-1450123124'
            ],
            '2.V.15.Jh.' => [
                'r1' => '1450.12.31.24',
                'r2' => '1426.01.01.00',
                'r3' => '1450.12.31.24',
                'key' => '1450123124-1426010100-1450123124'
            ],
            'M.15.Jh.' => [
                'r1' => '1450.12.31.24',
                'r2' => '1441.01.01.00',
                'r3' => '1459.12.31.24',
                'key' => '1450123124-1441010100-1459123124'
            ],
            '1450' => [
                'r1' => '1450.12.31.24',
                'r2' => '1450.01.01.00',
                'r3' => '1450.12.31.24',
                'key' => '1450123124-1450010100-1450123124'
            ],
            '1451' => [
                'r1' => '1451.12.31.24',
                'r2' => '1451.01.01.00',
                'r3' => '1451.12.31.24',
                'key' => '1451123124-1451010100-1451123124'
            ],
            '1466' => [
                'r1' => '1466.12.31.24',
                'r2' => '1466.01.01.00',
                'r3' => '1466.12.31.24',
                'key' => '1466123124-1466010100-1466123124'
            ],
            '2.D.15.Jh.' => [
                'r1' => '1467.12.31.24',
                'r2' => '1434.01.01.00',
                'r3' => '1467.12.31.24',
                'key' => '1467123124-1434010100-1467123124'
            ],
            '1467' => [
                'r1' => '1467.12.31.24',
                'r2' => '1467.01.01.00',
                'r3' => '1467.12.31.24',
                'key' => '1467123124-1467010100-1467123124'
            ],
            '1474' => [
                'r1' => '1474.12.31.24',
                'r2' => '1474.01.01.00',
                'r3' => '1474.12.31.24',
                'key' => '1474123124-1474010100-1474123124'
            ],
            '3.V.15.Jh.' => [
                'r1' => '1475.12.31.24',
                'r2' => '1451.01.01.00',
                'r3' => '1475.12.31.24',
                'key' => '1475123124-1451010100-1475123124'
            ],
            '1475' => [
                'r1' => '1475.12.31.24',
                'r2' => '1475.01.01.00',
                'r3' => '1475.12.31.24',
                'key' => '1475123124-1475010100-1475123124'
            ],
            '1499 o. früher' => [
                'r1' => '1499.12.31.24',
                'r2' => '1490.01.01.00',
                'r3' => '1499.12.31.24',
                'key' => '1499123124-1490010100-1499123124'
            ],
            '1499' => [
                'r1' => '1499.12.31.24',
                'r2' => '1499.01.01.00',
                'r3' => '1499.12.31.24',
                'key' => '1499123124-1499010100-1499123124'
            ],
            'vor 1500' => [
                'r1' => '1500.01.01.00',
                'r2' => '1491.01.01.00',
                'r3' => '1500.01.01.00',
                'key' => '1500010100-1491010100-1500010100'
            ],
            '2.H.15.Jh' => [
                'r1' => '1500.12.31.24',
                'r2' => '1451.01.01.00',
                'r3' => '1500.12.31.24',
                'key' => '1500123124-1451010100-1500123124'
            ],
            '3.D.15.Jh.' => [
                'r1' => '1500.12.31.24',
                'r2' => '1467.01.01.00',
                'r3' => '1500.12.31.24',
                'key' => '1500123124-1467010100-1500123124'
            ],
            '4.V.15.Jh.' => [
                'r1' => '1500.12.31.24',
                'r2' => '1476.01.01.00',
                'r3' => '1500.12.31.24',
                'key' => '1500123124-1476010100-1500123124'
            ],
            'E.15.Jh' => [
                'r1' => '1500.12.31.24',
                'r2' => '1491.01.01.00',
                'r3' => '1500.12.31.24',
                'key' => '1500123124-1491010100-1500123124'
            ],
            '1500 o. früher' => [
                'r1' => '1500.12.31.24',
                'r2' => '1491.01.01.00',
                'r3' => '1500.12.31.24',
                'key' => '1500123124-1491010100-1500123124'
            ],
            'um 1500' => [
                'r1' => '1500.12.31.24',
                'r2' => '1491.01.01.00',
                'r3' => '1509.12.31.24',
                'key' => '1500123124-1491010100-1509123124'
            ],
            '1500' => [
                'r1' => '1500.12.31.24',
                'r2' => '1500.01.01.00',
                'r3' => '1500.12.31.24',
                'key' => '1500123124-1500010100-1500123124'
            ],
            '1500 o. später' => [
                'r1' => '1500.12.31.24',
                'r2' => '1500.01.01.00',
                'r3' => '1509.12.31.24',
                'key' => '1500123124-1500010100-1509123124'
            ],
            'nach 1500' => [
                'r1' => '1500.12.31.24',
                'r2' => '1500.12.31.24',
                'r3' => '1509.12.31.24',
                'key' => '1500123124-1500123124-1509123124'
            ]
        ];
    }

    /**
     * tearDown method
     *
     * @return void
     */
    public function tearDown(): void
    {
        parent::tearDown();
    }


    public function testNormalization()
    {
        $testData = [
            '1520 - 22' => '1520–1522',
            '1520 - 1522' => '1520–1522',
            '1. Hälfte 14.Jh' => '1.H.14.Jh.'
        ];

        $result = array_map(
            fn($x) => HistoricDates::normalize($x),
            array_keys($testData)
        );

        $this->assertEquals(
            array_values($result),
            array_values($result)
        );
    }

    /**
     * Test date parsing
     *
     * @return void
     */
    public function testParsing(): void
    {
        $result = array_map(
            fn($x) => [
                'value' => HistoricDates::normalize($x),
                'sort' => HistoricDates::encode($x),
                'from' => HistoricDates::minyear($x),
                'to' => HistoricDates::maxyear($x)
            ],
            array_keys($this->testData)
        );

        $this->assertEquals(
            array_values($this->testData),
            $result
        );
    }

    /**
     * Test that the date order is correct,
     * based on the date key
     *
     * @return void
     */
    public function testOrder(): void
    {
        $result = array_map(
            fn($x, $no) => HistoricDates::encode($x) .  str_pad($no,4,"0", STR_PAD_LEFT),
            array_keys($this->testData),
            range(0, count($this->testData) -1)
        );

        // For debugging purposes
        $order = array_combine(
            array_column($this->testData, 'value'),
            array_values($result)
        );
        asort($order);

        // Assert correct order
        asort($result);
        $this->assertEquals(
            range(0, count($result) -1),
            array_keys($result)
        );
    }

    /**
     * Test next version of date parsing
     *
     * @incomplete
     * @return void
     */
    public function testOrderV5(): void
    {
        $this->markTestIncomplete('Not implemented yet.');

//        foreach ($this->testData_v5 as $date => &$parsed) {
//            $parsed['date'] = $date;
//            $parsed['key_v4'] = HistoricDates::encode($date);
//        }
//
//        $folder = Configure::read('Data.comparisons') . 'HistoricDatesTest';
//        Files::saveCsv( $folder, $this->testData_v5, true, 'dates_v5.csv');
//        $this->assertFileExists($folder . '/dates_v5.csv');

    }

}
