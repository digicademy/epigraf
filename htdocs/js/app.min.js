(()=>{"use strict";class e{static hide(e){e&&(e.originalDisplay=window.getComputedStyle(e).getPropertyValue("display"),e.style.display="none")}static show(e,t){e&&("none"===e.style.display&&(e.style.display=e.originalDisplay||"block"),"none"===e.style.display&&(e.style.display="block"),void 0!==t&&(e.textContent=t))}static toggle(e,t=!0){t?this.show(e):this.hide(e)}static isElementVisible(e){return"none"!==window.getComputedStyle(e).getPropertyValue("display")}waitFor(t,s=3e3){return new Promise(((i,n)=>{let r=0;const o=()=>{const a=document.querySelector(t);a&&e.isElementVisible(a)?i(a):r>=s?n(new Error("Element not loaded.")):(r+=50,setTimeout(o,50))};o()}))}static scrollToTop(e,t){e&&e.scrollIntoView(!0)}static getTotalOffset(e,t){let s=0,i=0,n=e;for(;n&&n!==t.offsetParent;)s+=n.offsetTop,i+=n.offsetLeft,n=n.offsetParent;return{top:s,left:i}}static getStickyElementHeight(e,t){const s=e.querySelector(t);if(s&&e!==s){if("sticky"===window.getComputedStyle(s).position)return s.offsetHeight}return 0}static scrollIntoViewIfNeeded(t,s,i=!0,n=!0){const r="y"===i||!0===i,o="x"===i||!0===i,a="y"===n||!0===n,l="x"===n||!0===n;if(!t||!e.isElementVisible(t))return;s=s||t.parentNode;const c=t.getBoundingClientRect();let u=s.getBoundingClientRect();const d=s.offsetHeight-s.clientHeight,p=e.getStickyElementHeight(s,"thead, li");u=new DOMRect(u.x,u.y+p,u.width,u.height-d-p);const h=c.top<u.top,g=c.bottom>u.bottom;if(a){let e;if(h&&!g?e=c.top-u.top:g&&!h&&(e=c.bottom-u.bottom),void 0!==e){if(r){let i=s.offsetHeight/2-t.offsetHeight/2;i=h?-i:+i,e+=i}s.scrollTop=s.scrollTop+e}}const m=c.left<u.left,f=c.right>u.right;if(l){let e;if(m&&!f?e=c.left-u.left:f&&!m&&(e=c.right-u.right),void 0!==e){if(o){let i=s.offsetWidth/2-t.offsetWidth/2;i=m?-i:+i,e+=i}s.scrollLeft=s.scrollLeft+e}}}static getParameterByName(e,t){t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");var s=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return s?s[2]?decodeURIComponent(s[2].replace(/\+/g," ")):"":null}static getValue(e,t,s=undefined){if(t&&Array.isArray(t)){for(let s of t){const t=this.getValue(e,s);if(void 0!==t)return t}return s}try{const i=t.split(".").reduce(((e,t)=>null==e||""===t?e:e.constructor===Array?e[parseInt(t)]:e[t]),e);return void 0===i?s:i}catch{return s}}static setValue(t,s,i,n=!1){return"string"==typeof s&&(s=s.replace(/\]/g,"").split(/[\[\.]/)),s.length>1?(t.hasOwnProperty(s[0])?"object"!=typeof t[s[0]]&&(t[s[0]]={}):t[s[0]]={},e.setValue(t[s[0]],s.slice(1),i,n)):n&&"object"==typeof t[s[0]]&&null!==t[s[0]]&&"object"==typeof i&&null!==i?t[s[0]]=Object.assign({},t[s[0]],i):t[s[0]]=i,t}static extractSnippetText(e,t){try{const s=(e=(new DOMParser).parseFromString(e,"text/html")).querySelector('[data-snippet="'+t+'"]');if(s)return s.textContent}catch{return""}return""}static wrapAll(e,t){return[...e.childNodes].forEach((e=>t.appendChild(e))),e.appendChild(t),t}static spawnFromString(t,s,i=!0){const n=document.createElement("template");return n.innerHTML=e.formatUnicorn(t.trim(),s),i?n.content.firstElementChild:n.content}static spawnFromTemplate(t,s,i=!0){if(t)return e.spawnFromString(t.text,s,i)}static childMatches(e,t){return[].some.call(e.children,(e=>e.matches(t)))}static setInputValue(e,t){e&&e.value!==t&&(e.value=t,e.disabled=!1,e.dataset.dirty=!0)}static getInputValue(e,t){return e?"checkbox"===e.type?e.checked?e.value:0:e.value:t}static removeInputConstraints(e){e.querySelectorAll("input").forEach((e=>{e.removeAttribute("min"),e.removeAttribute("max")}))}static getDataValue(e,t,s){return e&&e.dataset[t]||s}static setElementContent(e,t){e&&(e.innerHTML=t)}static setElementText(e,t){e&&(e.textContent=t)}static getElementText(e,t){return e?e.textContent:t}static getRenderedText(e,t=""){if(!e)return t;let s="";return function e(t){switch(t.nodeType){case Node.TEXT_NODE:s+=t.nodeValue.trim();break;case Node.ELEMENT_NODE:if("BUTTON"===t.tagName||"INPUT"===t.tagName&&"hidden"===t.type)s+="";else if(t.classList.contains("widget-dropdown-pane"))s+="";else if("SELECT"===t.tagName){const e=t.options[t.selectedIndex];e&&(s+=e.text.trim())}else if("INPUT"===t.tagName)s+=t.value;else for(const s of t.childNodes)e(s)}}(e),s||t}static extractElements(e,t,s){let i=[];return e.querySelectorAll(t).forEach((e=>{i.push(...Array.from(e.querySelectorAll(s))),e.remove()})),i}static toggleClass(e,t,s){s.forEach((t=>t.classList.remove(e))),t&&t.classList.add(e)}static removeClassByPrefix(e,t){let s=[];e.classList.forEach((e=>{0!==e.indexOf(t)&&s.push(e)})),e.className=s.join(" ")}static getClassValue(e,t){if(e)for(let s of e.classList)if(0===s.indexOf(t))return s.substring(t.length)}static encodeHtmlAttribute(e){return"string"!=typeof e?e:e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}static decodeHtmlAttribute(e){return"string"!=typeof e?e:e.replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&#39;/g,"'").replace(/&quot;/g,'"').replace(/&amp;/g,"&")}static formatUnicorn(t,s){for(const i in s){let n=new RegExp("\\{"+i+"\\}","gi");t=t.replace(n,s[i]);let r=new RegExp("\\{"+i+"\\|attr\\}","gi");t=t.replace(r,e.encodeHtmlAttribute(s[i]))}return t}static numberToLetters(t,s=!0,i=65,n=26){i="string"==typeof i?i.charCodeAt(0):i;let r=t<=0?"":e.numberToLetters(Math.floor((t-1)/n),s,i,n)+String.fromCharCode((t-1)%n+i);return s?r.toLowerCase():r.toUpperCase()}static numberToRoman(e,t=!0){const s={M:1e3,CM:900,D:500,CD:400,C:100,XC:90,L:50,XL:40,X:10,IX:9,V:5,IV:4,I:1};let i="";for(;e>0;)for(const t in s)if(e>=s[t]){e-=s[t],i+=t;break}return t?i.toLowerCase():i}static abbrNum(e){return e.toUpperCase().split("").reduce(((e,t)=>26*e+t.charCodeAt(0)-96),0)}static numberToString(t,s){switch(s){case"alphabetic":case"alphabetic-lower":return e.numberToLetters(t,!0);case"alphabetic-upper":return e.numberToLetters(t,!1);case"roman":case"roman-lower":return e.numberToRoman(t,!0);case"roman-upper":return e.numberToRoman(t,!1);case"greek":case"greek-lower":return e.numberToLetters(t,!0,"Α",24);case"greek-upper":return e.numberToLetters(t,!1,"Α",24);default:return String(t)}}static mod(e,t){return(e%t+t)%t}static isTrue(e,t=!1){return"string"==typeof e&&(e=e.toLowerCase()),null==e?t:1===e||"1"===e||!0===e||"true"===e}static isString(e){return"[object String]"===Object.prototype.toString.call(e)}static isVisible(e,t){const{bottom:s,height:i,top:n}=e.getBoundingClientRect(),r=t.getBoundingClientRect();return n<=r.top?r.top-n<=i:s-r.bottom<=i}static nearestPositionedAncestor(e){let t=e.parentElement;for(;t;){const e=window.getComputedStyle(t).position;if("relative"===e||"absolute"===e||"fixed"===e||"sticky"===e)return t;t=t.parentElement}return null}static getPrevSibling(e,t){let s=e.previousElementSibling;for(;s;){if(s.matches(t))return s;s=s.previousElementSibling}}static getNextSibling(e,t){if(!e)return;let s=e.nextElementSibling;for(;s;){if(s.matches(t))return s;s=s.nextElementSibling}}static getNextVisibleSibling(t,s){if(!t)return;let i=t.nextElementSibling;for(;i&&(!e.isElementVisible(i)||s&&!i.matches(s));)i=i.nextElementSibling;return i&&e.isElementVisible(i)&&(!s||i.matches(s))?i:void 0}static getPrevVisibleSibling(t,s){if(!t)return;let i=t.previousElementSibling;for(;i&&(!e.isElementVisible(i)||s&&!i.matches(s));)i=i.previousElementSibling;return i&&e.isElementVisible(i)&&(!s||i.matches(s))?i:void 0}static bottomAboveViewport(e,t){const s=e.getBoundingClientRect(),i=t.getBoundingClientRect();return s.bottom<i.bottom}static topBelowViewport(e,t){const s=e.getBoundingClientRect(),i=t.getBoundingClientRect();return s.top>i.top}static querySelectorLast(e,t){return[...e.querySelectorAll(t)].at(-1)}static querySelectorAndSelf(t,s){if(!Array.isArray(t))return t.matches&&t.matches(s)?t:t.querySelector(s);for(let i=0;i<t.length;i++){const n=e.querySelectorAndSelf(t[i],s);if(n)return n}}static querySelectorSelfAndContainer(e,t){return[e,e===document?null:e.closest(t)].filter((e=>null!==e&&e!==document&&e.matches(t)))}static querySelectorAllAndSelf(e,t){return[e,...e.querySelectorAll(t)].filter((e=>!(e instanceof DocumentFragment)&&e!==document&&e.matches(t)))}static querySelectorAllAndSelfAndContainer(e,t){const s=e?e.querySelectorAll(t):[],i=e&&e!==document?e.closest(t):null;return[e,...s,i].filter((e=>null!==e&&e!==document&&e.matches(t)))}static querySelectorText(e,t,s=""){return(e=e.querySelector(t))?e.textContent:s}static querySelectorData(e,t,s,i=""){return(e=e.querySelector(t))?e.dataset[s]:i}static listenEvent(e,t,s,i){if(!e)return;const n=e=>{if(e.defaultPrevented)return;if(void 0===i)return s(e);const t=e.target.closest(i);if(t&&e.currentTarget.contains(t)){if(("mouseover"===e.type||"mouseout"===e.type)&&t.contains(e.relatedTarget))return;return s.call(t,e)}};return e.eventListeners||(e.eventListeners={}),e.eventListeners[t]||(e.eventListeners[t]={}),e.eventListeners[t][i]||(e.eventListeners[t][i]=[]),e.eventListeners[t][i].push({source:s,target:n}),e.addEventListener(t,n)}static unlistenEvent(e,t,s,i){if(e&&e.eventListeners&&e.eventListeners[t]&&e.eventListeners[t][i]){const n=e.eventListeners[t][i];let r=n.length;for(;r--;){const i=n[r];i.source===s&&(e.removeEventListener(t,i.target),n.splice(r,1))}}}static emitEvent(e,t,s,i,n=!1){if(!e)return;let r=new CustomEvent(t,{bubbles:!0,cancelable:n,detail:{data:s,sender:i}});return e.dispatchEvent(r)}static getSelectionPosition(e){if(window.getSelection){const e=window.getSelection();if(e.rangeCount>0){return e.getRangeAt(0).startOffset}}return 0}static setSelectionPosition(e,t){const s=document.createRange(),i=window.getSelection();s.setStart(e.childNodes[0],t),s.collapse(!0),i.removeAllRanges(),i.addRange(s)}static lon2tile(e,t){return Math.floor((e+180)/360*Math.pow(2,t))}static lat2tile(e,t){return Math.floor((1-Math.log(Math.tan(e*Math.PI/180)+1/Math.cos(e*Math.PI/180))/Math.PI)/2*Math.pow(2,t))}static tile2long(e,t){return e/Math.pow(2,t)*360-180}static tile2lat(e,t){const s=Math.PI-2*Math.PI*e/Math.pow(2,t);return 180/Math.PI*Math.atan(.5*(Math.exp(s)-Math.exp(-s)))}static collapseWhitespace(e){return e.replace(/ +/g," ")}static prefixNumbersWithZero(e,t=1){return e.replace(/\d+/g,(e=>e.padStart(t,"0")))}static replaceSpacesWithHyphens(e){return e.replace(/\s+/g,"-")}static removeSpecialCharacters(e){return e.replace(/[^ ~a-z0-9\-_]/g,"")}static replaceUmlauts(e){return e.replace(/ä/g,"ae").replace(/ö/g,"oe").replace(/ü/g,"ue").replace(/Ä/g,"Ae").replace(/Ö/g,"Oe").replace(/Ü/g,"Ue").replace(/ß/g,"sz")}static extractNumber(e){return(e=e.match(/\d+/))?e[0]:""}static extractFileName(e){if(!e)return;return e.split(/[/\\]/).pop()}static parseFormData(t){const s={};for(const[i,n]of t.entries())e.setValue(s,i,n);return s}static formToUrl(e,t){let s=new URL(e.getAttribute("action"),t);const i=new URLSearchParams(new FormData(e));let n=s.searchParams;return n=new URLSearchParams({...Object.fromEntries(n),...Object.fromEntries(i)}),n=n.toString(),s.search=n,s.toString()}static toObject(e,t="data"){if("object"==typeof e)return e;if("string"==typeof e){const s={};return s[t]=e,s}throw new Error("Input must be an object or a string")}static groupElements(e,t,s=""){const i={};return e.forEach((e=>{let n=e.dataset[t];void 0===n&&void 0!==s&&(n=s),i[n]||(i[n]=[]),i[n].push(e)})),i}static splitString(e,t=","){return e?""===e?[]:Array.isArray(e)?e:e.split(t).map((e=>e.trim())).filter(Boolean):[]}static getPrefix(e,t=":",s=""){const i=e.indexOf(t);return-1!==i?e.substring(0,i):s}static evalCheckboxes(e){const t=e.querySelectorAll('input[type="checkbox"]'),s={};let i=!0;return t.forEach((e=>{s[e.name]=e.checked,i&&=e.checked})),[s,i]}static cleanId(e){return e.toString().toLowerCase().replace(/\s+/g,"-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-").replace(/^-+/,"").replace(/-+$/,"")}static getHorizontalDistance(e,t){const s=e.getBoundingClientRect(),i=t.getBoundingClientRect();return Math.max(i.left-s.right,s.left-i.right,0)}static replaceRecursive(t,s,...i){for(const n of i)for(const i in n)n.hasOwnProperty(i)&&("object"!=typeof n[i]||null===n[i]||Array.isArray(n[i])||"object"!=typeof s[i]||null===s[i]||Array.isArray(s[i])?t&&["number","string","boolean"].includes(typeof s[i])&&s[i]!==n[i]?s[i]+=","+n[i]:s[i]=n[i]:s[i]=e.replaceRecursive(!1,s[i],n[i]));return s}}const t=e;String.prototype.capitalize||(String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)}),$.fn.reverse=[].reverse,String.prototype.formatUnicorn||(String.prototype.formatUnicorn=function(){let t=this.toString();if(arguments.length){let s=typeof arguments[0],i="string"===s||"number"===s?Array.prototype.slice.call(arguments):arguments[0];t=e.formatUnicorn(t,i)}return t});class s{constructor(){this.pendingRequests=[],this.currentRequests=[],this.parallelRequests=3,this.requesting=0,this.stopped=!1}add(e,t,s){this.stopped=!1,this.pendingRequests.push({name:e,request:t,delay:s}),this.next()}stop(e){this.stopped=!0;for(let t=0;t<this.pendingRequests.length;t++)void 0!==e&&this.pendingRequests[t].name!==e||(this.pendingRequests.splice(t,1),t--);for(let t=0;t<this.currentRequests.length;t++)if(void 0===e||this.currentRequests[t].name===e){const e=this.currentRequests[t];this.currentRequests.splice(t,1),t--,e.timeout&&clearTimeout(e.timeout),e.request&&e.request.abort&&e.request.abort(),this.next()}}next(){const e=this;if(this.currentRequests.length>=this.parallelRequests)return;if(0===this.pendingRequests.length)return;const t=this.pendingRequests.splice(0,1)[0],s=t.request,i=s.complete;s.complete=function(){i&&i.apply(this,arguments);const s=e.currentRequests.indexOf(t);s>=0&&e.currentRequests.splice(s,1),e.next()},t.delay?t.timeout=setTimeout((()=>{t.request=$.ajax(s)}),t.delay):t.request=$.ajax(s),this.currentRequests.push(t)}}class i{constructor(){this.user=null,this.role=null,this.scope=null,this.settings=new n("user"),this.session=new n("session"),this.activeTimeout=3e5,this.initEvents()}initEvents(){document.querySelector("body").classList.contains("userrole_guest")||setTimeout((e=>this.updateActive(e)),this.activeTimeout)}load(e){e&&e.settings&&(this.settings.settings=e.settings,delete e.settings),e&&e.session&&(this.session.settings=e.session,delete e.session),Object.assign(this,e),this.settings.readonly="guest"===(this.role||"guest"),this.session.readonly="guest"===(this.role||"guest")}storeTheme(){window.matchMedia&&(window.matchMedia("(prefers-color-scheme: dark)").matches?this.session.save("ui","theme","dark"):this.session.save("ui","theme","light"))}async updateActive(){let e="/users/login.json";const s=t.getParameterByName("token");s&&(e=e+"?token="+s);try{const t=await fetch(e);(await t.json()).success||App.user.showLogin()}catch(e){App.showMessage("Could not connect to Epigraf: "+e)}setTimeout((e=>this.updateActive(e)),this.activeTimeout)}showLogin(e={}){(e=Object.assign({title:"Login",modal:!0,name:"app.login",ajaxButtons:!0,height:400,width:400},e)).onLoad=function(s,i,n){const r=t.querySelectorAndSelf(t.spawnFromString(i,void 0,!1),'[data-row-table="users"][data-row-id]');r&&r.dataset.rowId&&(s.closeWindow(),e.onLogin&&e.onLogin())},App.openPopup("/users/login?redirect=/users/view/me",e)}}class n{constructor(e="user"){this.settings={},this.settingsQueue={},this.readonly=!0,this.storage=e,this.ajaxQueue=new s}get(e,t,s){let i;return this.settings&&e&&!t?i=this.settings[e]:this.settings&&e&&this.settings[e]&&t&&(i=this.settings[e][t]),void 0===i?s:i}save(e,s,i,n=!0){if(this.readonly)return;this.settings=t.setValue(this.settings,e+"."+s,i,n);const r="/users/settings/"+e+"/"+s+"?storage="+this.storage;this.settingsQueue[r]={...this.settingsQueue[r]||{},...i};const o={type:n?"PATCH":"PUT",url:r,data:this.settingsQueue[r],dataType:"json",success:()=>this.settingsQueue[r]={}};this.ajaxQueue.stop(r),this.ajaxQueue.add(r,o,1e3)}}class r{constructor(e){this.modelParent=e,this.modelChildren=[],e&&e.modelChildren.push(this),this.eventListeners=[],this.resizeListeners=[],this.hasFocus=!1}listenEvent(e,s,i,n){if(e)if(e instanceof NodeList)e.forEach((e=>this.listenEvent(e,s,i,n)));else{t.listenEvent(e,s,i,n);const r={element:e,event:s,handler:i,selector:n};this.eventListeners.push(r),"submit"===s&&this.listenEvent(e,"epi:submit:form",i)}}unlistenEvent(e,s,i,n){let r=this.eventListeners.length;for(;r--;){const o=this.eventListeners[r];o.element!==e||o.event!==s||o.handler!==i&&i||o.selector!==n&&n||(t.unlistenEvent(e,o.event,o.handler,o.selector),this.eventListeners.splice(r,1))}"submit"===s&&this.unlistenEvent(e,"epi:submit:form",i)}emitEvent(e,s,i,n=!1){return t.emitEvent(e,s,i,this,n)}getWidget(e,t,s=!0){if(e)return s&&(e=e.closest(".widget-"+t)),e&&e.widgets?e.widgets[t]:void 0}clearWidget(){this.eventListeners.forEach((e=>t.unlistenEvent(e.element,e.event,e.handler,e.selector))),this.eventListeners=[],this.resizeListeners.forEach((e=>e.observer.unobserve(e.element))),this.resizeListeners=[],this.modelChildren.forEach((e=>e.clearWidget())),this.modelChildren=[]}}class o extends r{widgetElement=void 0;widgetName=void 0;widgetInitialized=!1;hasFocus=!1;constructor(e,t,s){super(s),this.widgetInitialized=!1,this.attachElement(e,t),this.listenEvent(document,"epi:clear:widgets",(e=>this.onClearWidgets(e.target))),this.listenEvent(document,"epi:init:widgets",(e=>this.onInitWidgets(e))),this.listenEvent(document,"focusout",(e=>this.onFocusChanged(e))),this.listenEvent(document,"focusin",(e=>this.onFocusChanged(e))),this.listenEvent(document,"click",(e=>this.onFocusChanged(e)))}clearWidget(){super.clearWidget(),this.detachElement(this.widgetElement,this.widgetName)}initWidget(){}updateWidget(){}onClearWidgets(e){e&&this.widgetElement&&e!==this.widgetElement&&e.contains(this.widgetElement)&&this.clearWidget()}attachElement(e,t,s=!0){s&&(this.widgetElement=e,this.widgetName=t),e&&t&&(e.widgets=e.widgets||{},e.widgets[t]=this)}detachElement(e,t){e&&t&&(e.widgets=e.widgets||{},delete e.widgets[t])}emitEvent(e,t,s){return super.emitEvent(this.widgetElement,e,t,s)}listenResize(e,t){if(e){const s=new ResizeObserver((e=>t(e)));s.observe(e);const i={element:e,observer:s,handler:t};this.resizeListeners.push(i)}}unlistenResize(e,t){t.unobserve(e)}spawnFromTemplate(e,s){const i=this.widgetElement.querySelector(".template."+e);return t.spawnFromTemplate(i,s)}onInitWidgets(e){this.widgetInitialized||(this.widgetInitialized=!0,this.initWidget())}onFocusChanged(e){this.widgetElement&&this.widgetElement instanceof Element&&(void 0===e?this.setFocus(!0):this.widgetElement.contains(e.target)?this.setFocus("focusout"!==e.type):"focusout"!==e.type&&this.setFocus(!1))}setFocus(e=!0){if(this.widgetElement&&this.widgetElement instanceof Element){if(this.hasFocus===e)return;this.hasFocus=e,this.widgetElement.classList.toggle("widget-focused",this.hasFocus),this.emitEvent("epi:focus:widgets",{focus:this.hasFocus})}}doFocus(){this.widgetElement&&this.widgetElement instanceof Element&&(this.setFocus(!0),this.widgetElement.focus())}getSetting(e,t){if("undefined"!=typeof App&&App.user.session){if(this.widgetElement&&this.widgetElement.dataset.uiKey){const t=App.user.session.get("ui",this.widgetElement.dataset.uiKey);if(void 0!==t&&e in t)return t[e]}return t}}setSetting(e,t){if("undefined"!=typeof App&&App.user.session&&this.widgetElement&&this.widgetElement.dataset&&this.widgetElement.dataset.uiKey){let s={};s[e]=t,App.user.session.save("ui",this.widgetElement.dataset.uiKey,s)}}getController(){return t.getClassValue(document.querySelector("body"),"controller_")}getAction(){return t.getClassValue(document.querySelector("body"),"action_")}getFrame(e=!0,t=!1){if(!this.widgetElement||this.widgetElement===document)return e?void 0:document;let s;return t&&this.widgetElement.classList.contains("widget-content-pane")&&(s=this.widgetElement),s||(s=this.widgetElement.closest(".widget-content-pane")),e?s?s.widgets["content-pane"]:void 0:s&&!s.classList.contains("widget-content-pane-main")?s:document}isInFrame(){return this.widgetElement&&null!==this.widgetElement.closest(".widget-content-pane")&&!this.widgetElement.closest(".widget-content-pane-main")}}class a extends o{constructor(e,t,s){super(e,t,s),this.driver=null}initWidget(){App.user.settings.get("tours","start",!1)&&"epi.articles.index"===App.getEndpoint()&&(this.driver=window.driver.js.driver,this.startArticlesTour())}addClickHandler(e,t){e&&e.tourListener&&e.removeEventListener("click",e.tourListener),e&&(e.tourListener=()=>t.moveNext(),e.addEventListener("click",e.tourListener))}removeClickHandler(e){e&&e.tourListener&&e.removeEventListener("click",e.tourListener),e.tourListener=null}startArticlesTour(){const e=this,s=this.driver({showProgress:!0,steps:[{element:".sidebar-left",popover:{title:"Left sidebar",side:"right",description:"Use filters in the left sidebar to select a specific project.",align:"start"}},{element:"[data-toggle=select-propertytype-pane]",popover:{title:"Filters",side:"left",description:"Klick the plus button to see more filter options.",align:"start"},onHighlightStarted:function(t,i,n){e.addClickHandler(t,s)},onDeselected:function(t,s,i){e.removeClickHandler(t)}},{element:"#select-propertytype-pane",popover:{title:"Filters",side:"right",description:"Select one of the category systems to show all properties in the sidebar.Then, you can filter articles that use one of the properties.",align:"start"},onHighlightStarted:function(i,n,r){t.isElementVisible(i)||document.querySelector("[data-toggle=select-propertytype-pane]").click(),e.addClickHandler(i,s)},onDeselected:function(s,i,n){e.removeClickHandler(s),t.isElementVisible(s)&&document.querySelector("[data-toggle=select-propertytype-pane]").click()}},{element:"[data-list-itemof=epi_articles]",popover:{title:"Show article preview",description:"Click on an article to view the content in the sidebar.",side:"bottom",align:"start"},onHighlightStarted:function(t,i,n){e.addClickHandler(t,s)},onDeselected:function(t,s,i){e.removeClickHandler(t)}},{element:".sidebar-right",popover:{title:"Inspect article",description:"The sidebar shows a preview of the article content.",side:"left",align:"center"},onHighlightStarted:async function(e,s,i){t.isElementVisible(e)||document.querySelector("[data-list-itemof=epi_articles]").click();try{await t.waitFor(".sidebar-right",3e3)}catch(e){}}},{element:".sidebar-right button.role-open",popover:{title:"Open article",description:"Open the article in a new tabsheet.",side:"top",align:"center"}}]});s.drive()}}window.App=new class{constructor(){this.settings={timeout:800,colwidth:150},this.data={},this.user=new i,this.ajaxQueue=new s,this.loaderCount=0,this.models={},this.widgets={},this.xhr=null,this.tours=new a,this.initEvents()}getEndpoint(){const e=t.getClassValue(document.body,"plugin_"),s=t.getClassValue(document.body,"controller_"),i=t.getClassValue(document.body,"action_");return e?e+"."+s+"."+i:s+"."+i}initEvents(){window.addEventListener("error",(e=>this.logError(e))),t.listenEvent(document,"click",(e=>this.hideMessage(e)),".message"),t.listenEvent(document,"click",(e=>this.openPopupLink(e)),"a.popup, a.popup *"),t.listenEvent(document,"click",(e=>this.openTabLink(e)),"a.tab, a.tab *"),t.listenEvent(document,"click",(e=>this.openDetailLink(e)),"a.frame, a.frame *"),t.listenEvent(document,"app:show:message",(e=>this.showMessage(e))),t.listenEvent(document,"app:hide:message",(e=>this.hideMessage())),t.listenEvent(document,"app:show:loader",(e=>this.showLoader())),t.listenEvent(document,"app:hide:loader",(e=>this.hideLoader())),t.listenEvent(document,"app:open:dialog",(e=>this.showDialog(e))),t.listenEvent(document,"app:close:dialog",(e=>this.hideDialog(e))),t.listenEvent(document,"epi:open:details",(e=>this.onOpenDetailsEvent(e)))}logError(e){if(!App.baseUrl||!App.user||!App.user.role||"guest"===App.user.role)return;const t=e.message||"Unknown error",s={name:e.error&&e.error.name||"Unknown error type",filename:e.filename||"Unknown file",line:e.lineno||0,column:e.colno||0,stack:e.error?e.error.stack:"No stack trace available",timestamp:(new Date).toISOString(),"Request URL":window.location.href,"Referer URL":document.referrer},i=new URL("/users/track/error/"+encodeURIComponent(t),App.baseUrl);fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}).then((e=>{e.ok?console.log("Sent error log to server"):console.error("Failed to log error to server",e.statusText)})).catch((e=>{console.error("Error while logging error to server:",e)}))}addWidget(e,t){return void 0!==e&&(this.widgets[e]=t),t}getWidget(e){if(void 0!==e)return this.widgets[e]||void 0}clearWidget(e){let t;return void 0!==e&&(t=this.getWidget(e),delete this.widgets[e]),t}focusContent(){let e=document.querySelectorAll(".content-wrapper input, .content-wrapper a, .content-wrapper select, .content-wrapper button");e.length>0&&e[0].focus()}showLoader(){this.loaderCount+=1,$("#loader").show()}hideLoader(){this.loaderCount-=1,this.loaderCount<=0&&(this.loaderCount=0,$("#loader").hide())}showMessage(e,s="error",i,n){if(e instanceof Event){s=e.detail.data.status||s;let t=e.detail.data.errors||{};!i&&e.detail.sender&&(i=e.detail.sender.getFrame(!0,!0)),e=e.detail.data.msg,t&&(e=e+"<br>"+Object.entries(t).flatMap((([e,t])=>t.map((t=>`${e}: ${t}`)))))}if(i)i.showMessage(e,s);else{const i=document.querySelector(".content-flash");if(i){let n=t.spawnFromString(`<div class="message ${s}">${e}</div>`);i.replaceChildren(n)}}const r=document.querySelector("#loader");r&&"error"===s&&r.classList.add("error")}hideMessage(e){if(!e||"A"!==e.target.tagName){const t=e?e.target.closest(".message"):document.querySelector(".message");t&&t.classList.add("hidden");const s=document.querySelector("#loader");s&&s.classList.remove("error")}}confirmAction(e){return new Promise(((t,s)=>{const i={message:e,onConfirm:e=>t(e)};App.confirmWindow.showData(i)}))}getFrame(e,t=!0){if(!e)return document;const s=e.closest(".widget-content-pane");if(t){const e=s?s.widgets["content-pane"]:document;return e||document}return s&&!s.classList.contains("widget-content-pane-main")?s:document}emitEvent(e,t,s,i=!1){let n=new CustomEvent(t,{bubbles:!0,cancelable:i,detail:{data:s,sender:this}});return e.dispatchEvent(n)}fetch(e,t){App.ajaxQueue.add("api",{type:"GET",url:e,dataType:"json",beforeSend:function(e){App.showLoader()},success:function(e,s,i){e.status="success",t(e)},error:function(e,s,i){e.readyState===XMLHttpRequest.UNSENT&&0===e.status?t({status:"abort"}):(t({status:"error"}),App.showMessage(i,s))},complete:function(e,t){App.hideLoader()}})}fetchHtml(e,s){null!==this.xhr&&this.xhr.abort(),App.showLoader(),this.xhr=$.ajax({type:"GET",url:e,dataType:"html",success:(e,i,n)=>{s(e);const r=t.extractSnippetText(e,"message");r&&this.showMessage(r)},error:(e,s,i)=>{if(e.readyState===XMLHttpRequest.UNSENT&&0===e.status)return;let n=t.extractSnippetText(e.responseText,"error");n||(n=i),this.showMessage(n,"error")},complete:(e,t)=>{this.hideLoader()}})}loadDataSnippets(e,s,i=!1,n=!1){null!==this.xhr&&this.xhr.abort(),App.showLoader(),this.xhr=$.ajax({type:"GET",url:e,dataType:"html",success:(r,o,a)=>{i&&window.history.pushState&&window.history.pushState(e,"Epigraf",e);const l=this.getFrame(s);this.replaceDataSnippets(r,s);const c=t.extractSnippetText(r,"message");c&&this.showMessage(c),n&&l&&l.updateNavigation&&l.updateNavigation(r),s&&this.emitEvent(s,"epi:load:content")},error:(e,s,i)=>{if(e.readyState===XMLHttpRequest.UNSENT&&0===e.status)return;let n=t.extractSnippetText(e.responseText,"error");n||(n=i),this.showMessage(n,"error")},complete:(e,t)=>{this.hideLoader()}})}replaceDataSnippets(e,s){const i=t.querySelectorAllAndSelf(t.spawnFromString(e,void 0,!1),"[data-snippet]");i&&(void 0!==s&&s!==document||(s=[document.querySelector(".widget-content-pane-main"),document.querySelector(".page-wrapper > footer")]),Array.isArray(s)||(s=[s]),i.forEach((e=>{const i='[data-snippet="'+e.dataset.snippet+'"]',n=t.querySelectorAndSelf(s,i);n&&("function"==typeof this.finishWidgets&&this.finishWidgets(n),n.replaceWith(e),"function"==typeof this.initWidgets&&this.initWidgets(e),this.emitEvent(n,"epi:replace:content",{newTarget:e}))})))}appendDataSnippets(e){$(e).find("[data-snippet]").addBack("[data-snippet]").each((function(e,t){$('[data-snippet="'+$(this).data("snippet")+'"]').after(this)}))}openPopupLink(e){if(e.detail>1)return;const t=e.target.closest("a");let s=t.href;if(s&&!e.ctrlKey&&!e.metaKey){const i=t.dataset.popupSize;let n=t.dataset.popupModal;return n="true"===n||"1"===n,App.openPopup(s,{external:!0,modal:n,focus:n,size:i}),e.preventDefault(),!1}}openTabLink(e){if(e.detail>1)return;let t=e.target.closest("a").href;return!t||e.ctrlKey||e.metaKey?void 0:(App.openTab(t),e.preventDefault(),!1)}openTab(e){window.open(e)}openDetailLink(e){if(e.detail>1||e.ctrlKey||e.metaKey)return;if(e.ctrlKey||e.metaKey)return;const t=e.target.closest(".ui-dialog, .sidebar"),s=e.target.closest(".ui-dialog"),i=e.target.closest("a");if(t&&i.dataset.linkwrapper)return e.preventDefault(),!1;if(s)return App.openPopupLink(e),e.preventDefault(),!1;let n=i.href;if(i.dataset.linkwrapper){const e=App.findWidget(i,"table");if(e){const t=i.closest(".node");n=e.getFirstAction(t)||n}}if(n){const t={external:i.dataset.frameExternal||!0,frameTarget:i.dataset.frameTarget||"details",frameCaption:i.dataset.frameCaption||"Details",force:!1};return App.openDetails(n,t),e.preventDefault(),!1}}onOpenDetailsEvent(e){let t;if(e.detail&&e.detail.data&&(t=e.detail.data.url),t){const s={external:!0,frameTarget:"details",frameCaption:"Details",force:!1};return App.openDetails(t,s),e.preventDefault(),!1}}openDetails(e,t){"string"==typeof e?(t=t||{}).url=e:"object"==typeof e?(t=t||{}).element=e:t=e||t||{};const s=App.findWidget(App.sidebarright.widgetElement,"tabsheets");s&&setTimeout((()=>{t.frameTarget=t.frameTarget||"details",t.frameCaption=t.frameCaption||"Details";const e=s.createTab(t.frameTarget,t.frameCaption);App.createWidget(e,"frame").showData(t)}),200)}activateTabsheet(e){App.sidebarright.showSidebar();return App.findWidget(App.sidebarright.widgetElement,"tabsheets").showTab(e)}}})();